<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="ssm.cm.dao.FamilyLetterDao">
	
	<resultMap type="ssm.mi.vo.TmemberVO" id="TmemberVO">
	    <result property="ttNo" 			column="TTNO"/>
	    <result property="ttName" 			column="TTNAME"/>
	</resultMap>
	
	<resultMap type="ssm.cm.vo.FamilyLetterVO" id="flVO">
	    <result property="flNo" 			column="FLNO"/>
	    <result property="flTitle" 			column="FLTITLE"/>
	    <result property="flContents" 		column="FLCONTENTS"/>
	    <result property="ttNo" 			column="TTNO"/>
	    <result property="flFile" 			column="FLFILE"/>
	    <result property="flInsertdate" 	column="FLINSERTDATE"/>
	    <result property="flUpdatedate" 	column="FLUPDATEDATE"/>
	    <result property="flDeleteyn" 		column="FLDELETEYN"/>
	    <collection property="tMembervo" 	resultMap="TmemberVO"/>
	</resultMap>
	
	<sql id="flCommon" >
		SELECT 
				A.FLNO, 
				B.TTNAME, 
				A.FLTITLE, 
				A.FLINSERTDATE
		FROM FAMILY_LETTER A, T_MEMBER B 
		WHERE FLDELETEYN ='Y'
		AND A.TTNO = B.TTNO
		
		<trim prefix="AND" >
			<if test="search=='flTitle' ">
				<![CDATA[FLTITLE LIKE '%'|| #{keyword} ||'%']]>
			</if>
			<if test="search=='flContents'">
				<![CDATA[FLCONTENTS LIKE '%'|| #{keyword} ||'%']]>
			</if>
			<if test="search=='flNo'">
				<![CDATA[TTNO LIKE '%'|| #{keyword} ||'%']]>
			</if>
		</trim>
	</sql>
	
	<select id ="fllist" parameterType="ssm.cm.vo.FamilyLetterVO" resultMap="flVO">
			SELECT 
					FLNO, 
					TTNAME, 
					FLTITLE, 
					FLINSERTDATE
					
			FROM 
			  (	SELECT 
						list.*,
						ROWNUM AS RNUM
				FROM(<include refid="flCommon"></include>
			   )list
			)
	</select>
	
	<select id="flChaebun" parameterType="ssm.cm.vo.FamilyLetterVO" resultMap="flVO">
		
		SELECT
		TO_CHAR(NVL(MAX(SUBSTR(FLNO,-4)),0)+1) FLNO
		FROM FAMILY_LETTER
		
	</select>
	
	<insert id="flInsert" parameterType="ssm.cm.vo.FamilyLetterVO">
	
		INSERT INTO FAMILY_LETTER(FLNO,TTNO,FLTITLE,FLCONTENTS,FLFILE,FLINSERTDATE,FLDELETEYN)
		VALUES(#{flNo},#{ttNo},#{flTitle},#{flContents},#{flFile},SYSDATE,'Y')
	
	</insert>
	
	<select id="pwdConfirm" parameterType="ssm.cm.vo.FamilyLetterVO" resultType="int">
		SELECT NVL((SELECT 1 FROM FAMILY_LETTER WHERE FLNO = #{flNo}),0)as result
		FROM dual
	</select>
	
	<update id="flUpdate" parameterType="ssm.cm.vo.FamilyLetterVO">
	
		UPDATE FAMILY_LETTER SET 
								 FLTITLE = #{flTitle}
								,FLCONTENTS = #{flContents}
								,FLFILE = #{flFile}
								,FLUPDATEDATE = SYSDATE
		WHERE 					 FLNO = #{flNo}						
		AND  					 FLDELETEYN = 'Y'
	</update>
	
	<update id="flDelete" parameterType="ssm.cm.vo.FamilyLetterVO">
	
		UPDATE FAMILY_LETTER SET 
								 FLUPDATEDATE = SYSDATE
								,FLDELETEYN = 'N' 
		WHERE 					 FLNO = #{flNo}						
		AND  					 FLDELETEYN = 'Y'
	</update>
	
	<select id="flDetail" parameterType="ssm.cm.vo.FamilyLetterVO" resultMap="flVO">
		SELECT
				A.FLNO, 
				B.TTNAME, 
				A.FLTITLE, 
				A.FLCONTENTS, 
				A.FLINSERTDATE, 
				A.FLUPDATEDATE,
				A.FLDELETEYN
		FROM FAMILY_LETTER A, T_MEMBER B
		WHERE FLNO =#{flNo}
		AND FLDELETEYN='Y'
		AND A.TTNO = B.TTNO
	</select>
	
</mapper>